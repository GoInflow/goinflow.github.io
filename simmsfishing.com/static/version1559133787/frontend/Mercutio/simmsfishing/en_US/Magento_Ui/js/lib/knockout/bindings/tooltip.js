define(["jquery","ko","underscore","mage/template","text!ui/template/tooltip/tooltip.html","../template/renderer"],function(a,t,p,i,n,o){"use strict";var c,u,d,l,m,g,f={},e=0,s={},r={},w="ontouchstart"in document.documentElement,z=w?"touchstart":"click";g={trigger:!(u={tooltipWrapper:"[data-tooltip=tooltip-wrapper]",tooltipContentBlock:"data-tooltip-content",closeButtonClass:"action-close",tailClass:"data-tooltip-tail",action:"hover",delay:300,track:!1,step:20,position:"top",closeButton:!1,showed:!1,strict:!0,center:!1}),timeout:0,element:!1,event:!1,targetElement:{},showed:!1,currentID:0},l=function(){var t,o=document.createElement("div").style,e=["webkit","moz","ms","o"],i=e.length;if(void 0!==o.transform)return"transform";for(;i--;)if(void 0!==o[t=e[i]+"Transform"])return t}(),d={map:{horizontal:{s:"w",p:"left"},vertical:{s:"h",p:"top"}},top:function(t){return d._topLeftChecker(t,d.map,"vertical","_bottom","top","right")},left:function(t){return d._topLeftChecker(t,d.map,"horizontal","_right","left","top")},bottom:function(t){return d._bottomRightChecker(t,d.map,"vertical","_top","bottom","left")},right:function(t){return d._bottomRightChecker(t,d.map,"horizontal","_left","right","bottom")},_topLeftChecker:function(t,o,e,i,n,r){var l,s={position:{}},a=c.getTooltip(g.currentID),p=a.strict?t.elementPosition:t.eventPosition;return f[n]=!0,s=p[o[e].p]-t.tooltipSize[o[e].s]-a.step>t.scrollPosition[o[e].p]?(s.position[o[e].p]=p[o[e].p]-t.tooltipSize[o[e].s]-a.step,s.className=i,s.side=n,l="vertical"===e?"horizontal":"vertical",d._normalize(t,s,a,r,o,l)):f[r]?d.positionCenter(t,s):d[r].apply(null,arguments)},_bottomRightChecker:function(t,o,e,i,n,r){var l,s={position:{}},a=c.getTooltip(g.currentID),p=a.strict?{top:t.elementPosition.top+t.elementSize.h,left:t.elementPosition.left+t.elementSize.w}:t.eventPosition;return f[n]=!0,s=p[o[e].p]+t.tooltipSize[o[e].s]+a.step<t.scrollPosition[o[e].p]+t.windowSize[o[e].s]?(s.position[o[e].p]=p[o[e].p]+a.step,s.className=i,s.side=n,l="vertical"===e?"horizontal":"vertical",d._normalize(t,s,a,r,o,l)):f[r]?d.positionCenter(t,s):d[r].apply(null,arguments)},positionCenter:function(t,o){return o=d._positionCenter(t,o,"horizontal",d.map),o=d._positionCenter(t,o,"vertical",d.map)},_positionCenter:function(t,o,e,i){return t.tooltipSize[i[e].s]<t.windowSize[i[e].s]?o.position[i[e].p]=(t.windowSize[i[e].s]-t.tooltipSize[i[e].s])/2+t.scrollPosition[i[e].p]:(o.position[i[e].p]=t.scrollPosition[i[e].p],o.tooltipSize={},o.tooltipSize[i[e].s]=t.windowSize[i[e].s]),o},_normalize:function(t,o,e,i,n,r){var l,s=e.center?{left:t.elementPosition.left+t.elementSize.w/2,top:t.elementPosition.top+t.elementSize.h/2}:t.eventPosition;return s[n[r].p]-t.tooltipSize[n[r].s]/2>t.scrollPosition[n[r].p]&&s[n[r].p]+t.tooltipSize[n[r].s]/2<t.scrollPosition[n[r].p]+t.windowSize[n[r].s]?o.position[n[r].p]=s[n[r].p]-t.tooltipSize[n[r].s]/2:o=f[i]?d._normalizeTail(t,o,e,i,n,r,s):(l=d[i].apply(null,arguments)).hasOwnProperty("className")?l:d._normalizeTail(t,o,e,i,n,r,s),o},_normalizeTail:function(t,o,e,i,n,r,l){return o.tail={},t.tooltipSize[n[r].s]<t.windowSize[n[r].s]?(l[n[r].p]>t.windowSize[n[r].s]/2+t.scrollPosition[n[r].p]?o.position[n[r].p]=t.windowSize[n[r].s]+t.scrollPosition[n[r].p]-t.tooltipSize[n[r].s]:o.position[n[r].p]=t.scrollPosition[n[r].p],o.tail[n[r].p]=l[n[r].p]-t.tooltipSize[n[r].s]/2-o.position[n[r].p]):(o.position[n[r].p]=t.scrollPosition[n[r].p],o.tail[n[r].p]=t.eventPosition[n[r].p]-t.windowSize[n[r].s]/2,o.tooltipSize={},o.tooltipSize[n[r].s]=t.windowSize[n[r].s]),o}},c={setTooltip:function(t){var o="id-"+e;return r[o]=t,e++,o},getTooltip:function(t){return r[t]},setContent:function(t,o,e,i,n){var r=a(t).html(),l=c.getTooltip(e),s=a("body");g.currentID=e,g.trigger=a(n.currentTarget),c.setTargetData(n),s.on("mousemove.setTargetData",c.setTargetData),c.clearTimeout(e),g.timeout=p.delay(function(){s.off("mousemove.setTargetData",c.setTargetData),g.trigger[0]===g.targetElement&&(c.destroy(e),n.stopPropagation(),(t=c.createTooltip(e)).find("."+u.tooltipContentBlock).append(r),t.applyBindings(i),c.setHandlers(e),c.setPosition(t,e),m=e)},l.delay)},setPosition:function(t,o){var e=c.getTooltip(o);c.sizeData={windowSize:{h:a(window).outerHeight(),w:a(window).outerWidth()},scrollPosition:{top:a(window).scrollTop(),left:a(window).scrollLeft()},tooltipSize:{h:t.outerHeight(),w:t.outerWidth()},elementSize:{h:g.trigger.outerHeight(),w:g.trigger.outerWidth()},elementPosition:g.trigger.offset(),eventPosition:this.getEventPosition(g.event)},p.extend(s,d[e.position](c.sizeData)),t.css(s.position),t.addClass(s.className),c._setTooltipSize(s,t),c._setTailPosition(s,t),f={}},_setTooltipSize:function(t,o){t.tooltipSize&&(t.tooltipSize.w?o.css("width",t.tooltipSize.w):o.css("height",t.tooltipSize.h))},_setTailPosition:function(t,o){var e,i;t.tail&&(e=o.find("."+u.tailClass),t.tail.left?(i=parseInt(e.css("margin-left"),10),e.css("margin-left",i+t.tail.left)):(i=parseInt(e.css("margin-top"),10),e.css("margin-top",i+t.tail.top)))},getEventPosition:function(t){var o={left:t.originalEvent&&t.originalEvent.pageX||0,top:t.originalEvent&&t.originalEvent.pageY||0};return 0===o.left&&0===o.top&&p.extend(o,t.target.getBoundingClientRect()),o},outerClick:function(t,o){var e=a(o.target).parents(u.tooltipWrapper)[0],i=o.target===g.trigger[0]||a.contains(g.trigger[0],o.target);g.showed&&e!==g.element[0]&&!i&&c.destroy(t)},keydownHandler:function(t){g.showed&&27===t.keyCode&&c.destroy(g.currentID)},track:function(t){var o={},e=d.map,i={left:t.pageX,top:t.pageY},n={w:g.element.outerWidth(),h:g.element.outerHeight()},r="bottom"===s.side||"top"===s.side?"horizontal":"vertical";if(o[e[r].p]=i[e[r].p]-(s.position[e[r].p]+n[e[r].s]/2),s.position[e[r].p]+o[e[r].p]+c.sizeData.tooltipSize[e[r].s]>c.sizeData.windowSize[e[r].s]+c.sizeData.scrollPosition[e[r].p]||o[e[r].p]+s.position[e[r].p]<c.sizeData.scrollPosition[e[r].p])return!1;g.element[0].style[l]={left:"translateX",top:"translateY"}[e[r].p]+"("+o[e[r].p]+"px)"},setHandlers:function(t){var o=c.getTooltip(t);o.track&&g.trigger.on("mousemove.track",c.track),"click"===o.action&&a(window).on(z+".outerClick",c.outerClick.bind(null,t)),o.closeButton&&a("."+o.closeButtonClass).on("click.closeButton",c.destroy.bind(null,t)),document.addEventListener("scroll",c.destroy,!0),a(window).on("keydown.tooltip",c.keydownHandler),a(window).on("scroll.tooltip",c.outerClick.bind(null,t)),a(window).on("resize.outerClick",c.outerClick.bind(null,t))},toggleTooltip:function(t,o,e){if(m===e&&g.showed)return c.destroy(e),!1;c.setContent.apply(null,arguments)},createTooltip:function(t){var o=a("body"),e=c.getTooltip(t);return a(i(n,{data:e})).appendTo(o),g.showed=!0,g.element=a(e.tooltipWrapper),g.element},clearTimeout:function(t){"hover"===c.getTooltip(t).action&&clearTimeout(g.timeout)},checkPreviousTooltip:function(){g.timeout||c.destroy()},destroy:function(){g.element&&(g.element.remove(),g.showed=!1),s={},g.timeout=!1,c.removeHandlers()},removeHandlers:function(){a("."+u.closeButtonClass).off("click.closeButton"),g.trigger.off("mousemove.track"),document.removeEventListener("scroll",c.destroy,!0),a(window).off(z+".outerClick"),a(window).off("keydown.tooltip"),a(window).off("resize.outerClick")},setTargetData:function(t){(g.event=t).timeStamp-(g.timestamp||0)<1||("mousemove"===t.type?g.targetElement=t.target:(g.targetElement=t.currentTarget,g.timestamp=t.timeStamp))},processingConfig:function(t){return p.extend({},u,t)}},t.bindingHandlers.tooltip={init:function(t,o,e,i,n){var r,l=c.processingConfig(o()),s=l.parentScope?a(l.parentScope):a(t).parent();return a(t).addClass("hidden"),w&&(l.action="click"),r=c.setTooltip(l),"hover"===l.action?(s.on("mouseenter",l.trigger,c.setContent.bind(null,t,i,r,n)),s.on("mouseleave",l.trigger,c.checkPreviousTooltip.bind(null,r))):"click"===l.action&&s.on("click",l.trigger,c.toggleTooltip.bind(null,t,i,r,n)),{controlsDescendantBindings:!0}}},o.addAttribute("tooltip")});
