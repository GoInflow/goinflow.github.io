define(["jquery","underscore","./loader"],function(i,a,t){"use strict";var r,e,n=/\\:/g,o={},d={},u=[];return(r={render:function(e){return t.loadTemplate(e).then(r.parseTemplate)},parseTemplate:function(e){var t=document.createDocumentFragment();return i(t).append(e),r.normalize(t)},normalize:function(t){return u.forEach(function(e){e(t)}),a.toArray(t.childNodes)},addGlobal:function(e){return a.contains(u,e)||u.push(e),this},removeGlobal:function(e){var t=u.indexOf(e);return~t&&u.splice(t,1),this},addAttribute:function(e,t){var n={name:e,binding:e,handler:r.handlers.attribute};return a.isFunction(t)?n.handler=t:a.isObject(t)&&a.extend(n,t),n.id=e,o[e]=n,this},removeAttribute:function(e){return delete o[e],this},addNode:function(e,t){var n={name:e,binding:e,handler:r.handlers.node};return a.isFunction(t)?n.handler=t:a.isObject(t)&&a.extend(n,t),n.id=e,d[e]=n,this},removeNode:function(e){return delete d[e],this},isCustomNode:function(t){return a.some(d,function(e){return e.name.toUpperCase()===t.tagName})},processAttributes:function(t){a.some(o,function(n){var r=n.name,e=t.querySelectorAll("["+r+"]"),o=n.handler;return a.toArray(e).some(function(e){var t=e.getAttribute(r);return!0===o(e,t,n)})})&&r.processAttributes(t)},processNodes:function(t){a.some(d,function(n){var e=t.querySelectorAll(n.name),r=n.handler;return a.toArray(e).some(function(e){var t=e.getAttribute("args");return!0===r(e,t,n)})})&&r.processNodes(t)},wrapArgs:function(e){return~e.indexOf("\\:")?e=e.replace(n,":"):~e.indexOf(":")&&!~e.indexOf("}")&&(e="{"+e+"}"),e},wrapChildren:function(e,t,n){var r=this.createComment(t,n),o=i(e);o.prepend(r.open),o.append(r.close)},wrapNode:function(e,t,n){var r=this.createComment(t,n),o=i(e);o.before(r.open),o.after(r.close)},createComment:function(e,t){return{open:document.createComment(" ko "+e+": "+t+" "),close:document.createComment(" /ko ")}}}).handlers={node:function(e,t,n){return t=r.wrapArgs(t),r.wrapNode(e,n.binding,t),i(e).replaceWith(e.childNodes),!0},attribute:function(e,t,n){t=r.wrapArgs(t),r.bindings.add(e,n.binding,t),e.removeAttribute(n.name)},wrapAttribute:function(e,t,n){t=r.wrapArgs(t),r.wrapNode(e,n.binding,t),e.removeAttribute(n.name)}},r.bindings={add:function(e,t,n){var r=this.get(e);r&&(r+=", "),r+=t,n&&(r+=": "+n),this.set(e,r)},get:function(e){return e.getAttribute("data-bind")||""},set:function(e,t){e.setAttribute("data-bind",t)}},r.addGlobal(r.processAttributes).addGlobal(r.processNodes),e={nodes:a.object(["if","text","with","scope","ifnot","foreach","component"],Array.prototype),attributes:a.object(["css","attr","html","with","text","click","event","submit","enable","disable","options","visible","template","hasFocus","textInput","component","uniqueName","optionsText","optionsValue","checkedValue","selectedOptions"],Array.prototype)},a.extend(e.attributes,{if:r.handlers.wrapAttribute,ifnot:r.handlers.wrapAttribute,innerif:{binding:"if"},innerifnot:{binding:"ifnot"},outereach:{binding:"foreach",handler:r.handlers.wrapAttribute},foreach:{name:"each"},value:{name:"ko-value"},style:{name:"ko-style"},checked:{name:"ko-checked"},disabled:{name:"ko-disabled",binding:"disable"},focused:{name:"ko-focused",binding:"hasFocus"},render:function(e,t){t=t||"getTemplate()",t=r.wrapArgs(t),r.wrapChildren(e,"template",t),e.removeAttribute("render")}}),a.extend(e.nodes,{foreach:{name:"each"},render:function(e,t){t=t||"getTemplate()",t=r.wrapArgs(t),r.wrapNode(e,"template",t),i(e).replaceWith(e.childNodes)}}),a.each(e.attributes,function(e,t){r.addAttribute(t,e)}),a.each(e.nodes,function(e,t){r.addNode(t,e)}),r});
