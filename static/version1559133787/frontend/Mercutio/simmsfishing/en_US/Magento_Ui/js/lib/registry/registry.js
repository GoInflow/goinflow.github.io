define(["jquery","underscore","es6-collections"],function(i,u){"use strict";var e=new WeakMap;function n(t){return e.get(t).items}function r(t){return e.get(t).requests}function s(t){var e,n,i={};if("string"!=typeof t||!~t.indexOf("="))return t;for(e=(t=t.split(",")).length;e--;)i[(n=t[e].split("="))[0].trim()]=n[1].trim();return i}function o(t,e,n){var i,r;return"string"==typeof(e=s(e))?(r=t[e],n?r?[r]:[]:r):(i=u.isFunction(e)?e:function(t,e){var n,i,r,s=!0;if(!u.isObject(t)||!u.isObject(e))return!1;for(n=(i=Object.getOwnPropertyNames(t)).length;s&&n--;)e[r=i[n]]!=t[r]&&(s=!1);return s}.bind(null,e),n?u.filter(t,i):u.find(t,i))}function t(){this._updateRequests=u.debounce(this._updateRequests.bind(this),10),e.set(this,{items:{},requests:[]})}return t.prototype={constructor:t,get:function(t,e){if("function"!=typeof e)return o(n(this),t);this._addRequest(t,e)},set:function(t,e){return n(this)[t]=e,this._updateRequests(),this},remove:function(t){return delete n(this)[t],this},filter:function(t){return o(n(this),t,!0)},has:function(t){return!!this.get(t)},contains:function(t){return u.contains(n(this),t)},indexOf:function(e){return u.findKey(n(this),function(t){return e===t})},promise:function(t){var e=i.Deferred(),n=e.resolve.bind(e);return this.get(t,n),e.promise()},async:function(t){return function(t,e,n){var i=u.toArray(arguments).slice(3);if(u.isString(n))e.get(t,function(t){t[n].apply(t,i)});else if(u.isFunction(n))e.get(t,n);else if(!i.length)return e.get(t)}.bind(null,t,this)},create:function(){return new t},_addRequest:function(t,e){var n;return Array.isArray(t)||(t=t?[t]:[]),n={queries:t.map(s),callback:e},this._canResolve(n)?this._resolveRequest(n):r(this).push(n),this},_updateRequests:function(){return r(this).filter(this._canResolve,this).forEach(this._resolveRequest,this),this},_resolveRequest:function(t){var e=r(this),n=t.queries.map(this.get,this),i=e.indexOf(t);return t.callback.apply(null,n),~i&&e.splice(i,1),this},_canResolve:function(t){return t.queries.every(this.has,this)}},new t});
